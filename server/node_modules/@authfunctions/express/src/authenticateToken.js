const { onTrigger, sendError } = require("./utils")
const jwt = require("jsonwebtoken")
const { getprop } = require("varkeeper")

//express middleware to authenticate that a user is logged in
module.exports = (req, res, next) => {
  //get the token from the Authorization header
  const authHeader = req.headers["authorization"];
  const token = authHeader && authHeader.split(" ")[1];

  //if token does not exist send error
  if (!token) return sendError(1, res);

  //verify the passed token
  jwt.verify(token, getprop("config").jwt.ACCESS_TOKEN_SECRET, (err, user) => {
    //if token is invalid send error
    if (err) return sendError(4, res);

    //trigger event that a user has authenticated and pass the users informations
    onTrigger("authenticate", user);

    //add users informations to the request
    req.user = user;

    //execute next middleware
    next();
  });
}